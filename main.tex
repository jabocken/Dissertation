%        File: VTthesis_template.tex
%     Created: Thu Mar 24 11:00 AM 2016 EDT
%     Updated from Thursday, December 19, 2019 version
%      Author: Alan M. Lattimer, VT
%	   With modifications by Carrie Cross, Robert Browder, and LianTze Lim.
%
% This template is designed to operate with XeLaTeX.
%
% All elements in the Title, Abstract, and Keywords MUST be formatted as text and NOT as math.
%
% Further instructions for using this template are embedded in the document. Additionally, there are comments at the end of the file that give suggestions on writing your thesis.
%
% In addition to the standard formatting options, the following options are defined for the VTthesis class: proposal, prelim, doublespace, draft.

% no pageskip is technically the "correct" style for book printing/two-page reading but adds unnecessary pages when viewing one at a time.
\documentclass[pageskip]{VTthesis}

\usepackage{comment}               % for commenting out large amounts of stuff
\usepackage{suffix}                % For defining command versions with *s
\usepackage{relsize}               % Necessary for the \Cpp\ command

\usepackage{stmaryrd}              % St Mary Road symbols for theoretical computer science (necessary for record/etc.\ symbols)
\usepackage{textcomp}              % Fixes issue with microtype+siunitx's \micro
\usepackage{wasysym}               % for \checked
\usepackage[bbgreekl]{mathbbol} % because amsfonts don't provide \mathbb for \Sigma
\usepackage{faktor}                % Can use the package because this isn't ACM

% Still want to use AMS fonts for all the stuff they do cover though! mathbbol style is kind of ugly.
\DeclareSymbolFontAlphabet{\mathbbm}{bbold}
\DeclareSymbolFontAlphabet{\mathbb}{AMSb}%

\usepackage[en-US]{datetime2}      % For \DTMdate, etc.
\usepackage{siunitx}
\usepackage{bussproofs}            % for prooftree environment
\usepackage[epsilon]{backnaur}     % For BNF diagrams; a (more complex?) alternative is the syntax package

\usepackage{makecell}              % For table heading cells and cells with line breaks
\usepackage{threeparttable}        % For tables with notes

\usepackage{acro}                  % For acronyms

\renewcommand*\theadfont{} % not making table text small so no need for small heading

% foreign/display=false used to avoid bug with plural initial forms (leaving out for now as I don't know if this is still an issue); single used to leave out abbreviation if the acronym is only used once. make-links works with hyperref but I don't know if it has issues with XeLaTeX like the old version
\acsetup{index/use, single, make-links} % Can't seem to get format/first-long to apply to a plural form (this is still an issue!); include-endings should do it but it's not. It also looks silly with single so just leaving out.

\input{preamble/acronyms}
\input{preamble/listingsetup}
\input{preamble/numbers}
\input{preamble/registers}
\input{preamble/tikz}
\input{preamble/memory}
\input{preamble/glossaries}

% Defined after it's used in commands above but looks like that's okay in LaTeX.
\newcommand*\mathasm[1]{\text{\inlineasm{#1}}}

\newcommand*\mcsquare{\textsc{[mc]square}}

\newcommand*\keywordstyle{\ttfamily\bfseries\color{blue}}
\newcommand\keyword[1]{{\keywordstyle#1}}
\newcolumntype{A}{>{\begingroup\ttfamily\bfseries\color{blue}}l<{\endgroup}}

%% Math commands
\newcommand{\letin}[2]{\textbf{let} \(#1\) \textbf{such that} \(#2\)}
\newcommand{\ind}[1]{\hspace{#1}}
%\newcommand*{\eqsetfix}{\mathrel{\phantom{=}}\phantom{\{}} % What were these used for?
%\newcommand*{\equivsetfix}{\mathrel{\phantom{\equiv}}\phantom{\{}}

\newcommand{\infloop}{\bot_\mathrm{NT}}
\newcommand{\err}{\bot_\mathrm{E}}
\newcommand{\bop}{\mathbin\bigcirc}

\DeclareMathOperator{\powerset}{\mathcal P}

\DeclareMathOperator{\unat}{unat}
\DeclareMathOperator{\snd}{snd}
\newcommand{\concat}{\bullet}
\newcommand{\mmerge}{\text{ merge }}
\newcommand{\var}[1]{\mathit{#1}}

\DeclareMathOperator{\run}{\textsc{runUntil}}
\DeclareMathOperator{\loc}{loc}
\DeclareMathOperator{\rbxpops}{\textsc{multiplicandsPushed}}
\DeclareMathOperator{\retsites}{\textsc{retAddrsPushed}}
\DeclareMathOperator{\retaddress}{\textsc{retAddress}}
\DeclareMathOperator{\seps}{\bigotimes}

\DeclareMathOperator{\blockusage}{block_usage}
\DeclareMathOperator{\nbo}{\textsc{noBlockOverflow}}
\DeclareMathOperator{\sextend}{sextend}
\DeclareMathOperator{\usage}{preserve}
\DeclareMathOperator{\exec}{\textsc{execScf}}
\DeclareMathOperator{\execblock}{\textsc{symbExec}}

\newcommand*{\ASeq}{\mathrel{\texttt{;}}}
\WithSuffix{\newcommand*}\ASeq*{\texttt{;}}
\newcommand*{\AWhile}{\texttt{Loop}}
\newcommand*{\AOd}{\texttt{Pool}}
\newcommand*{\AIf}{\texttt{If}}
\newcommand*{\AThen}{\texttt{Then}}
\newcommand*{\AElse}{\texttt{Else}}
\newcommand*{\AFi}{\texttt{Fi}}
\newcommand*{\ABB}{\texttt{Block}}
\newcommand*{\ASkip}{\texttt{Skip}}
\newcommand*{\ACall}{\texttt{Call}}
\newcommand*{\ABreak}{\texttt{Break}}
\newcommand*{\AContinue}{\texttt{Continue}}
\newcommand*{\AWhileResume}{\texttt{Resume}}

\DeclareMathOperator{\scf}{scf}
\DeclareMathOperator{\pre}{pre}
\DeclareMathOperator{\post}{post}
\DeclareMathOperator{\ID}{ID}
\DeclareMathOperator{\exit}{exit}
\DeclareMathOperator{\sccs}{SCCS}
\DeclareMathOperator{\sem}{sem}
\DeclareMathOperator{\subst}{subst}

\DeclarePairedDelimiter{\takebits}{\langle}{\rangle}
\DeclarePairedDelimiter{\abs}{\lvert}{\rvert}

\newcommand\Block[2]{\mathtt{#1\texttt{->}#2}}
\WithSuffix\newcommand\Block*[3]{#1~#2~#3}

\newcommand\htriple[3]{\{#1\}#2\{#3\}}
\WithSuffix\newcommand\htriple*[4]{\{#1\}#2\{#3{;}#4\}}
\newcommand\parent[3]{\operatorname{parent}(#1,#2,#3)}
\newcommand\writeM{\stackrel{M}{=}}
\newcommand\writeR{\stackrel{R}{=}}
\newcommand\writeF{\stackrel{F}{=}}
\newcommand\writeone[3][\sigma]{#1\llparenthesis #2\writeM #3\rrparenthesis}

\newcommand{\deqptr}{\var{deq}_\mathrm{ptr}}
\newcommand{\bufferptr}{\var{buf}_\mathrm{ptr}}
\newcommand{\outptr}{\var{out}_\mathrm{ptr}}
\newcommand{\valueptr}{\var{value}_\mathrm{ptr}}

\newcommand{\retaddr}{\text{\lstinline|ret_addr|}}

\newcommand{\psep}{P_\mathrm{sep}}

%% FROM PLDI 2022 (Hoare graph) paper
\newcommand*{\cons}{\mathbin{:}}
\newcommand*{\sepdot}{\cdot}

\DeclareMathOperator\suprem{sup}

% Variable names for algorithms; maybe make into glossary?
\newcommand{\nextstates}{\var{nextStates}}

% not really sure what to do with this yet
\newcommand*{\relmiddle}[1]{\mathrel{}\middle#1\mathrel{}}

%% From EICFG (TACAS 2023) paper
% Freek did not like the line number stuff so using manual inst refs (but still keeping the hyperlinks!)
% This is a bit of a pain as it means I have to figure out the instruction addresses instead of getting them directly, oh well...
\newcommand*\instref[2]{\hyperref[#1]{\texttt{0x#2}}}

\DeclareMathOperator{\stateToNode}{\alpha'}

% For abstract interpretation
\newcommand\absTransition{\xrightarrow{\mathsf A}}
\newcommand\concTransition{\xrightarrow{\mathsf C}}
\newcommand\alphagamma{\langle\alpha,\gamma\rangle}
\newcommand\unwindTransition{\xrightarrow{\mathsf U}}
\newcommand\unwindTransitionyes{\xRightarrow{\mathsf U^+}}
\newcommand\unwindTransitionno{\xRightarrow{\mathsf U^-}}
\WithSuffix\newcommand\unwindTransition*{\xRightarrow[P]{\mathsf U}}

% abstract transition predicate abbreviations
%\DeclareMathOperator\csr{CSR}
\newcommand\dec{\mathbin{--}}
\newcommand\inc{\mathbin{++}}
\WithSuffix\newcommand\dec*{\ominus}
\WithSuffix\newcommand\inc*{\oplus}
\DeclareMathOperator\handler{handler}
\DeclareMathOperator\reth{rethrown}

% stack ops
\DeclareMathOperator{\push}{push}
\DeclareMathOperator{\pop}{pop}
\DeclareMathOperator{\peek}{peek}

\DeclareMathOperator\pushStack{pushStack}
\DeclareMathOperator\popStack{popStack}
%\DeclareMathOperator\peekStack{peekStack}

\DeclareMathOperator\pushCaught{pushCaught}
\DeclareMathOperator\popCaught{popCaught}
%\DeclareMathOperator\peekCaught{peekCaught}

% state/etc. fields
\DeclareMathOperator\landingpadtable{\mathsf{LPT}}
\newcommand{\stack}{\mathsf{stack}}
\newcommand\caught{\mathsf{caught}}
\newcommand\uncaught{\mathsf{uncaught}}

% exception object stuff
\DeclareMathOperator\emap{\mathsf{emap}}
\DeclareMathOperator\rmap{\mathsf{rmap}}
\newcommand\objectID{\mathsf{objectID}}
\newcommand\handlerCount{\mathsf{handlerCount}}
\newcommand\rethrown{\mathsf{rethrown}}
\newcommand\typeInfo{\mathsf{typeInfo}}
\newcommand\id{\mathit{id}}

\DeclareMathOperator{\terminate}{terminate} % two args, state and termination state
\newcommand{\terminated}{\mathsf{terminated}}
\DeclareMathOperator{\transform}{transform}
\DeclareMathOperator{\unwinding}{unwinding} % might not use

% Terminating conditions
\newcommand\good{\mathtt{Good}}
\newcommand\bad{\mathtt{Bad}}

% Misc. commands
\newcommand{\todo}[1]{{\bfseries\color{purple}#1}} % Allowing paragraphs in todos
\newcommand*{\fturl}[1]{\footnote{\url{#1}}}

\input{preamble/titlepages}

\addbibresource{bibliography.bib}

\includeonly{hg-discussion,hg-formulation,hg-lifting,hg-results}

\newcommand\nomenclature[3][]{}

%\makeindex[intoc]
\begin{document}
  \frontmatter % Stuff that goes before the body of the book; all the pages get Roman numerals and there's no chapter numbering
%  \maketitle

  \microtypesetup{protrusion=false} % suggested by the docs to avoid the list dots getting misaligned
  \tableofcontents
  \listofalgorithms
  \listoffigures
  \lstlistoflistings
  \listoftables
  \listoftheorems
  \microtypesetup{protrusion=true}

  \printacronyms[heading=chapter]
  \printunsrtglossary[type=symbols,style=indexgroup] % no default style for symbols
  \printunsrtglossary[type=numbers,style=indexgroup] % no default style for numbers

  \include{attribution} % prefaces go in front matter

  \mainmatter % The body chapters get proper numbering.
  \acresetall % Any acronyms used inside the glossaries should start over here. Will replace with \gls version when switching acronyms over

  \part{Introductory Elements}
  \include{introduction}
  \include{related}
  \include{background}
  \include{symbolic_execution}

  \part{Methods of Analyzing Memory Usage}\label{memory-preservation}
  \include{cfg}
  \include{syntax}

  \part{Hoare Graphs}\label{hg}
  \include{hg-lifting}
  \include{hg-formulation}
  \include{hg-results}
  \include{hg-discussion}

  \part{Exceptional Interprocedural Control Flow Graphs}\label{eicfg}
  \include{eicfg}
  \include{eicfg-formulation}
  \include{eicfg-validation}

  \part{Finals}
  \include{conclusions}

  {% appendices don't work right with \backmatter due to it getting rid of counters
    \backmatter % All the stuff that comes after the body chapters
    \printbibliography[heading=bibintoc]
%    \printindex % Interferes with glossaries-extra index
    \printunsrtglossary[style=indexgroup] % Default glossary (this stuff normally goes in back matter); for whatever reason the default style doesn't format @index/child @entries right (extra desc, not including name)
    \printunsrtglossary[type=index,style=bookindex] % default style not good for index
  }
%  \appendix % formats the chapter name to appendix to properly define the headers
%  \begin{appendices}
%  	\chapter{First Appendix} \label{app:appendix_one}
%  		\section{Section one} \label{ase:app_one_sect_1}
%      \clearpage
%  		\section{Section two} \label{ase:app_one_sect_2}
%  	\chapter{Second Appendix} \label{app:appendix_two}
%      \clearpage
%  		\section{Section a}
%  \end{appendices}
\end{document}
